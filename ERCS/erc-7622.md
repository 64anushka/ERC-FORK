---
eip: 7622
title: Pre-Authorized Service Payment Protocol
description: A protocol for automated, pre-approved ERC-20 deductions by authorized providers.
author: Chen Liaoyuan (@bizliaoyuan) <bizliaoyuan@gmail.com>
discussions-to: https://ethereum-magicians.org/t/eip-7622-pre-authorized-service-payment-protocol/18586
status: Draft
type: Standards Track
category: ERC
created: 2024-02-10
requires: 20
---

## Abstract

This proposal introduces a protocol for implementing pre-authorization capabilities in [ERC-20](./eip-20.md) token payments, while simultaneously facilitating the aggregation of token funds. Users deposit [ERC-20](./eip-20.md) tokens into the contract, acquiring a total authorized balance that can be distributed to various service providers for expenditure. The protocol empowers users to pre-authorize specific service providers to deduct funds up to a predetermined limit, ensuring seamless and secure transactions. Additionally, users retain the ability to withdraw unutilized authorized balances, modify, or revoke authorizations for specific service providers as needed. Through this framework, the protocol enhances the efficiency, security, and flexibility of [ERC-20](./eip-20.md) token payments within decentralized applications.

## Motivation

In the current Ethereum ecosystem, users encounter the inconvenience of needing to manually confirm each transaction when transferring funds to third parties. This becomes particularly cumbersome for services necessitating frequent micro-payments. Additionally, in certain DApps, there's a desire to obtain user fund authorizations without relying on ERC-20's `approve` method. This reluctance stems from the fact that `approve` does not involve placing funds in a trusted third-party entity.

To address this concern, there's a proposal to introduce a third-party contract capable of receiving and managing authorized funds. These third-party entities could include reputable organizations, such as charities or authoritative institutions. By channeling authorized funds into a dedicated pool, these entities could generate charitable returns or facilitate community benefits.

Furthermore, there's potential to implement governance mechanisms, such as DAO governance or transparent public oversight, for managing the list of authorized service providers. This would enhance trust and transparency, allowing users to dynamically manage their authorizations while ensuring the integrity of the service provider ecosystem. Through these enhancements, the proposed Pre-Authorized Service Payment Protocol not only streamlines transaction processes but also fosters trust, transparency, and community engagement within the Ethereum ecosystem.

## Specification

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119 and RFC 8174.

### Interface

```solidity
pragma solidity ^0.8.20;

interface IERC7622 {
    // Events

    /**
     * @dev Event emitted when a service provider is registered.
     * @param serviceProvider The address of the registered service provider.
     */
    event ServiceProviderRegistered(address serviceProvider);

    /**
     * @dev Event emitted when a service provider is deregistered.
     * @param serviceProvider The address of the deregistered service provider.
     */
    event ServiceProviderDeregistered(address serviceProvider);

    /**
     * @dev Event emitted when authorization amount is updated.
     * @param user The address of the user whose authorization is updated.
     * @param serviceProvider The address of the service provider.
     * @param newAuthorizedAmount The new authorized amount.
     */
    event AuthorizationUpdated(address indexed user, address indexed serviceProvider, uint256 newAuthorizedAmount);

    /**
     * @dev Event emitted when funds are deducted.
     * @param user The address of the user from whom funds are deducted.
     * @param serviceProvider The address of the service provider.
     * @param amount The amount of funds deducted.
     * @param referenceId The reference ID associated with the deduction.
     */
    event FundsDeducted(address indexed user, address indexed serviceProvider, uint256 amount, string referenceId);

    /**
     * @dev Event emitted when funds are deposited.
     * @param user The address of the user who deposited funds.
     * @param amount The amount of funds deposited.
     */
    event Deposited(address indexed user, uint256 amount);

    /**
     * @dev Event emitted when authorization is revoked.
     * @param user The address of the user who revoked authorization.
     * @param serviceProvider The address of the service provider.
     */
    event AuthorizationRevoked(address indexed user, address indexed serviceProvider);

    /**
     * @dev Event emitted when funds are withdrawn.
     * @param user The address of the user who withdrew funds.
     * @param amount The amount of funds withdrawn.
     */
    event Withdrawal(address indexed user, uint256 amount);

    // External functions

    /**
     * @dev Registers a new service provider.
     * @param serviceProvider The address of the service provider to be registered.
     */
    function registerServiceProvider(address serviceProvider) external;

    /**
     * @dev Deregisters a service provider.
     * @param serviceProvider The address of the service provider to be deregistered.
     */
    function deregisterServiceProvider(address serviceProvider) external;

    /**
     * @dev Allows users to authorize a service provider to deduct funds.
     * @param serviceProvider The address of the service provider to authorize.
     * @param amount The amount of funds to authorize for deduction.
     */
    function authorizeServiceProvider(address serviceProvider, uint256 amount) external;

    /**
     * @dev Revokes authorization for a service provider to deduct funds.
     * @param serviceProvider The address of the service provider for which authorization is to be revoked.
     */
    function revokeAuthorization(address serviceProvider) external;

    /**
     * @dev Deducts funds from the user's pre-authorized amount.
     * @param user The address of the user from whom funds will be deducted.
     * @param amount The amount of funds to deduct.
     * @param referenceId The reference ID associated with the deduction.
     */
    function deductAuthorizedFunds(address user, uint256 amount, string calldata referenceId) external;

    /**
     * @dev Allows users to deposit funds into the contract.
     * @param amount The amount of funds to deposit.
     */
    function deposit(uint256 amount) external;

    /**
     * @dev Allows users to withdraw remaining balance.
     * @param amount The amount of funds to withdraw.
     */
    function withdraw(uint256 amount) external;

    // View functions

    /**
     * @dev Returns the authorized amount for a user and service provider.
     * @param user The address of the user.
     * @param serviceProvider The address of the service provider.
     * @return The authorized amount.
     */
    function authorizedAmount(address user, address serviceProvider) external view returns (uint256);

    /**
     * @dev Checks if a service provider is registered.
     * @param serviceProvider The address of the service provider to check.
     * @return True if the service provider is registered, otherwise false.
     */
    function isServiceProviderRegistered(address serviceProvider) external view returns (bool);

    /**
     * @dev Returns the remaining balance for a user.
     * @param user The address of the user.
     * @return The remaining balance.
     */
    function remainingBalance(address user) external view returns (uint256);
}
```

#### Base

The `registerServiceProvider(address serviceProvider)` function `MUST` be implemented as public or external.

The `deregisterServiceProvider(address serviceProvider)` function `MUST` be implemented as public or external.

The `authorizeServiceProvider(address serviceProvider, uint256 amount)` function `MUST` be implemented as public or external.

The `revokeAuthorization(address serviceProvider)` function `MUST` be implemented as public or external.

The `deductAuthorizedFunds(address user, uint256 amount, string calldata referenceId)` function `MUST` be implemented as public or external.

The `authorizedAmount(address user, address serviceProvider)` function `MUST` be implemented as pure or view.

The `isServiceProviderRegistered(address serviceProvider)` function `MUST` be implemented as pure or view.

The `ServiceProviderRegistered` event `MUST` be emitted when a service provider is registered.

The `ServiceProviderDeregistered` event `MUST` be emitted when a service provider is deregistered.

The `AuthorizationUpdated` event `MUST` be emitted when authorization amount is updated.

The `FundsDeducted` event `MUST` be emitted when funds are deducted.

The `AuthorizationRevoked` event `MUST` be emitted when authorization is revoked.

#### Recharge Extension

The deposit and withdraw functions for users are `OPTIONAL` in implementation, as funds can be transferred directly from the user's account in real-time during the `authorizeServiceProvider` operation.  

The `deposit(uint256 amount)` function `OPTIONAL` be implemented as public or external.

The `withdraw(uint256 amount)` function `OPTIONAL` be implemented as public or external.

The `remainingBalance(address user)` function `OPTIONAL` be implemented as pure or view.

The `Deposited` event `OPTIONAL` be emitted when funds are deposited.

The `Withdrawal` event `OPTIONAL` be emitted when when funds are withdrawn.

## Rationale

The primary motivation behind the Pre-Authorized Service Payment Protocol stems from the need for a more efficient and secure transaction mechanism between users and service providers within the Ethereum blockchain. While ERC-20's `approve` method provides a means to authorize fund usage, there's a recognition that the authorized funds could be put to better use.

By introducing this protocol, the aim is to optimize the utilization of authorized funds, ensuring that they serve a meaningful purpose beyond mere approval. This not only streamlines the transaction process but also maximizes the utility of authorized funds, enhancing the overall efficiency and effectiveness of transactions within the Ethereum ecosystem.

## Reference Implementation

See [`ERC7622.sol`](../assets/eip-7622/contracts/ERC7622.sol).

## Security Considerations

The protocol includes several security measures to ensure the safety of user funds and the integrity of service provider transactions. These measures include checks for service provider registration, user authorization levels, and transaction limits. Implementations of this protocol must rigorously enforce these security checks to prevent unauthorized fund deductions and protect against potential abuses.

## Copyright

Copyright and related rights waived via [CC0](../LICENSE.md).
